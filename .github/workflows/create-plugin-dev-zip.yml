name: Create Plugin Dev Zip
on:
  workflow_call:
    inputs:
      aws_upload:
        required: false
        type: boolean
        default: false
        description: "If true, package zip and upload to S3 bucket (adds aws_s3_public_url output)."
      zip_file_suffix:
        required: false
        type: string
        default: ""
        description: "Optional suffix appended to the base zip name; include leading dash yourself (e.g. -temp, -beta1). Leave empty for none."
    secrets:
      AWS_ACCESS_KEY_ID_KROKEDIL_PLUGIN_DEV_ZIP:
        required: false
      AWS_SECRET_ACCESS_KEY_KROKEDIL_PLUGIN_DEV_ZIP:
        required: false
    outputs:
      zip_file_name:
        description: Built dev zip base name (without .zip)
        value: ${{ jobs.create_plugin_dev_zip.outputs.zip_file_name }}
      aws_s3_public_url:
        description: Public S3 URL (only valid if aws_upload was true)
        value: ${{ jobs.create_plugin_dev_zip.outputs.aws_s3_public_url }}

jobs:
  create_plugin_dev_zip:
    runs-on: ubuntu-latest
    outputs:
      zip_file_name: ${{ steps.prepare.outputs.zip_file_name }}
      aws_s3_public_url: ${{ steps.upload.outputs.aws_s3_public_url }}
    steps:
      - name: Checkout plugin repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout CI helpers
        uses: actions/checkout@v4
        with:
          repository: krokedil/krokedil-wp-ci
          path: .github/krokedil-wp-ci
          fetch-depth: 1

      - name: Get plugin meta
        id: meta
        run: bash .github/krokedil-wp-ci/scripts/get-plugin-meta.sh

      - name: Prepare plugin dev zip
        id: prepare
        env:
          PLUGIN_SLUG: ${{ steps.meta.outputs.plugin_slug }}
          ZIP_FILE_SUFFIX: ${{ inputs.zip_file_suffix }}
        run: bash .github/krokedil-wp-ci/scripts/prepare-plugin-dev-zip.sh

      - name: Generate plugin zip and upload as artifact
        id: generate
        uses: krokedil/action-wordpress-plugin-build-zip@krokedil-improvements
        env:
          SLUG: ${{ steps.meta.outputs.plugin_slug }}
        with:
          upload-plugin-artifact: true
          retention-days: 1
          artifact-name: ${{ steps.prepare.outputs.zip_file_name }}

      - name: Configure AWS credentials (optional)
        if: inputs.aws_upload == true
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_KROKEDIL_PLUGIN_DEV_ZIP }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_KROKEDIL_PLUGIN_DEV_ZIP }}
          aws-region: eu-north-1

      - name: Upload to S3 (optional)
        id: upload
        if: inputs.aws_upload == true
        env:
          PLUGIN_SLUG: ${{ steps.meta.outputs.plugin_slug }}
          ZIP_FILE_NAME: ${{ steps.prepare.outputs.zip_file_name }}
          ZIP_FILE_PATH: ${{ steps.generate.outputs.zipfile-path }}
        run: bash .github/krokedil-wp-ci/scripts/upload-zip-aws-s3.sh

      - name: Run shared integration tests (Vitest)
        working-directory: .github/krokedil-wp-ci/tests/plugin-dev-zip
        env:
          DEV_ZIP_URL: ${{ steps.upload.outputs.aws_s3_public_url }}
        run: |
          npm ci
          npm test

      - name: Run shared e2e tests (Playwright)
        working-directory: .github/krokedil-wp-ci/tests/plugin-dev-zip
        env:
          E2E_BASE_URL: ${{ steps.upload.outputs.aws_s3_public_url }}
        run: |
          npx playwright install --with-deps
          npm run test:e2e

      - name: Create job summary
        id: summary
        env:
          PLUGIN_META_JSON: ${{ steps.meta.outputs.plugin_meta_json }}
          ZIP_FILE_NAME: ${{ steps.prepare.outputs.zip_file_name }}
          AWS_S3_PUBLIC_URL: ${{ steps.upload.outputs.aws_s3_public_url }}
        run: node .github/krokedil-wp-ci/scripts/job-summary-create-plugin-dev-zip.js
